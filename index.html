<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hawks House Manager</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <!-- jsPDF for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #16a34a;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Toast Animation */
        .toast-enter { transform: translateX(100%); opacity: 0; }
        .toast-enter-active { transform: translateX(0); opacity: 1; transition: all 300ms ease-out; }
        .toast-exit { transform: translateX(0); opacity: 1; }
        .toast-exit-active { transform: translateX(100%); opacity: 0; transition: all 300ms ease-in; }
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #aaa; }
        /* Search Highlight */
        .highlight { background-color: #a7f3d0; border-radius: 2px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen overflow-hidden flex">

    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-90 z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-green-700">Hawks Admin</h1>
                <p class="text-gray-500 mt-2">Enter your credentials to access the dashboard.</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="username" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" required>
                </div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    Sign In
                </button>
                <div id="login-error" class="text-red-500 text-sm text-center hidden">Invalid credentials</div>
            </form>
        </div>
    </div>

    <!-- Sidebar -->
    <aside class="w-64 bg-green-800 text-white flex-col hidden md:flex shadow-xl">
        <div class="p-6 text-center border-b border-green-700">
            <h2 class="text-2xl font-bold">ðŸ¦… Hawks</h2>
            <p class="text-xs text-green-300 mt-1">Data Management System</p>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="router('on-stage')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-green-700 transition" data-target="on-stage">
                <i class="ph ph-microphone-stage text-xl"></i><span>On Stage</span>
            </button>
            <button onclick="router('off-stage')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-green-700 transition" data-target="off-stage">
                <i class="ph ph-pencil-simple text-xl"></i><span>Off Stage</span>
            </button>
            <button onclick="router('sports')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-green-700 transition" data-target="sports">
                <i class="ph ph-trophy text-xl"></i><span>Sports</span>
            </button>
            <button onclick="router('statistics')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-green-700 transition" data-target="statistics">
                <i class="ph ph-chart-bar text-xl"></i><span>Statistics</span>
            </button>
            <button onclick="router('logs')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-green-700 transition" data-target="logs">
                <i class="ph ph-scroll text-xl"></i><span>Logs</span>
            </button>
            <button onclick="router('export')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-green-700 transition" data-target="export">
                <i class="ph ph-download-simple text-xl"></i><span>Export Data</span>
            </button>
        </nav>
        <div class="p-4 border-t border-green-700">
            <button onclick="logout()" class="w-full flex items-center justify-center space-x-2 px-4 py-2 bg-red-600 rounded hover:bg-red-700 transition">
                <i class="ph ph-sign-out"></i><span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full relative">
        <!-- Mobile Header -->
        <header class="md:hidden bg-green-800 text-white p-4 flex justify-between items-center">
            <div>
                <h1 class="font-bold text-lg">Hawks Manager</h1>
                <p id="mobile-user-greeting" class="text-xs text-green-300"></p>
            </div>
            <button onclick="toggleMobileMenu()" class="p-2"><i class="ph ph-list text-2xl"></i></button>
        </header>
        
        <!-- Mobile Menu (Hidden by default) -->
        <div id="mobile-menu" class="hidden absolute top-14 left-0 w-full bg-green-900 text-white z-40 p-4 shadow-lg">
             <!-- Mobile nav items generated by JS or static -->
             <div class="flex flex-col space-y-2">
                <button onclick="router('on-stage'); toggleMobileMenu()" class="mobile-nav-item flex items-center space-x-3 p-3 rounded-lg hover:bg-green-700 transition" data-target="on-stage">
                    <i class="ph ph-microphone-stage text-xl"></i><span>On Stage</span>
                </button>
                <button onclick="router('off-stage'); toggleMobileMenu()" class="mobile-nav-item flex items-center space-x-3 p-3 rounded-lg hover:bg-green-700 transition" data-target="off-stage">
                    <i class="ph ph-pencil-simple text-xl"></i><span>Off Stage</span>
                </button>
                <button onclick="router('sports'); toggleMobileMenu()" class="mobile-nav-item flex items-center space-x-3 p-3 rounded-lg hover:bg-green-700 transition" data-target="sports">
                    <i class="ph ph-trophy text-xl"></i><span>Sports</span>
                </button>
                <button onclick="router('statistics'); toggleMobileMenu()" class="mobile-nav-item flex items-center space-x-3 p-3 rounded-lg hover:bg-green-700 transition" data-target="statistics">
                    <i class="ph ph-chart-bar text-xl"></i><span>Statistics</span>
                </button>
                <button onclick="router('logs'); toggleMobileMenu()" class="mobile-nav-item flex items-center space-x-3 p-3 rounded-lg hover:bg-green-700 transition" data-target="logs">
                    <i class="ph ph-scroll text-xl"></i><span>Logs</span>
                </button>
                <button onclick="router('export'); toggleMobileMenu()" class="mobile-nav-item flex items-center space-x-3 p-3 rounded-lg hover:bg-green-700 transition" data-target="export">
                    <i class="ph ph-download-simple text-xl"></i><span>Export Data</span>
                </button>
                 <button onclick="logout()" class="flex items-center justify-center space-x-2 p-3 text-red-400 bg-red-900/50 rounded-lg mt-4">Logout</button>
             </div>
        </div>

        <div id="content-area" class="flex-1 overflow-auto p-6 md:p-8 bg-gray-50">
            <!-- Content Injected via JS -->
            <div class="flex justify-center items-center h-full">
                <div class="loader"></div>
            </div>
        </div>

        <!-- Toast Notification Container -->
        <div id="toast-container" class="fixed bottom-5 right-5 z-50 flex flex-col space-y-2"></div>
    </main>

    <!-- Generic Modal -->
    <div id="modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-[60] hidden flex items-center justify-center p-4">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800">Modal Title</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 p-2 rounded-full">
                    <i class="ph ph-x text-2xl"></i>
                </button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto">
                <!-- Modal content goes here -->
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS & CONFIG ---
        const SUPABASE_URL = 'https://elxyhkfuuugjskallwsp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVseHloa2Z1dXVnanNrYWxsd3NwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg4MjA5ODksImV4cCI6MjA1NDM5Njk4OX0.BAEvcCVIQiVdsg0m3xX72Xi0p-vnJ4WqfZU0mE_Tuk0';
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const EVENTS = {
            'on-stage': [
                "Recitation (Malayalam)", "Recitation (English)", "Recitation (Hindi)",
                "Group Song", "Solo Song", "Vanchipattu", "Solo Dance", "Group Dance",
                "Mime", "Nadanpattu", "Fancy Dress", "Spot Choreography",
                "Solo Dance (Cinematic)", "Solo Dance (Classical)", 
                "Group Dance (Cinematic)", "Group Dance (Classical)", "Light Music"
            ],
            'off-stage': [
                "Essay Writing (Malayalam)", "Essay Writing (English)", "Essay Writing (Hindi)",
                "Short Story Writing (Malayalam)", "Short Story Writing (English)", "Short Story Writing (Hindi)",
                "Poem Writing (Malayalam)", "Poem Writing (English)", "Poem Writing (Hindi)",
                "Elocution (Malayalam)", "Elocution (English)", "Elocution (Hindi)",
                "Pencil Drawing", "Cartoon Drawing", "Watercolor Painting", "Collage",
                "Mehandi Competition", "Photography Competition", "Reels Competition", "Quiz"
            ],
            'sports': [
                "100m", "200m", "800m", "1500m", "4x100m Relay",
                "Javelin", "Discus Throw", "Shot Put",
                "Cricket", "Football", "Volleyball",
                "Badminton Singles", "Badminton Doubles", "Chess"
            ]
        };

        // --- STATE ---
        let currentUser = null;
        let hawksData = [];
        let currentView = '';

        // --- SUPABASE CLIENT HELPER ---
        function createClient(url, key) {
            return window.supabase.createClient(url, key);
        }

        // --- UTILS ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bgClass = type === 'success' ? 'bg-green-600' : 'bg-red-600';
            toast.className = `${bgClass} text-white px-6 py-3 rounded shadow-lg transform transition-all duration-300 translate-x-full opacity-0 flex items-center`;
            toast.innerHTML = `
                <i class="ph ${type === 'success' ? 'ph-check-circle' : 'ph-warning-circle'} mr-2 text-xl"></i>
                <span>${message}</span>
            `;
            container.appendChild(toast);

            // Animate In
            requestAnimationFrame(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
            });

            // Remove after 3s
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => container.removeChild(toast), 300);
            }, 3000);
        }

        async function logAction(action, details) {
            if (!currentUser) return;
            try {
                await supabase.from('hawks_logs').insert([{
                    action: action,
                    admin_username: currentUser,
                    details: details
                }]);
            } catch (e) {
                console.error("Logging failed", e);
            }
        }

        function openModal(title, content) {
            document.getElementById('modal-title').innerHTML = title;
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
            document.getElementById('modal-title').innerHTML = '';
            document.getElementById('modal-body').innerHTML = '';
        }


        // --- AUTH ---
        function checkSession() {
            const loggedInUser = localStorage.getItem('hawksAdminUser');
            if (loggedInUser) {
                currentUser = loggedInUser;
                document.getElementById('mobile-user-greeting').innerText = `Hi, ${currentUser}`;
                document.getElementById('login-overlay').classList.add('hidden');
                // We don't log 'LOGIN' here as it's a session resumption
                initApp();
                showToast(`Welcome back, ${currentUser}!`, 'success');
            }
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            const btn = e.target.querySelector('button');

            btn.disabled = true;
            btn.innerHTML = '<div class="loader w-5 h-5 border-2 border-white border-t-transparent"></div>';

            try {
                const { data, error } = await supabase
                    .from('hawks_login')
                    .select('*')
                    .eq('username', u)
                    .eq('password', p)
                    .single();

                if (error || !data) {
                    throw new Error("Invalid credentials");
                }

                currentUser = data.username;
                document.getElementById('mobile-user-greeting').innerText = `Hi, ${currentUser}`;
                localStorage.setItem('hawksAdminUser', currentUser); // Save session
                document.getElementById('login-overlay').classList.add('hidden');
                initApp();
                logAction('LOGIN', 'User logged in');
                showToast(`Welcome back, ${currentUser}!`);
            } catch (err) {
                errorDiv.classList.remove('hidden');
                errorDiv.innerText = "Invalid Username or Password";
            } finally {
                btn.disabled = false;
                btn.innerText = 'Sign In';
            }
        });

        function logout() {
            logAction('LOGOUT', 'User logged out');
            currentUser = null;
            localStorage.removeItem('hawksAdminUser'); // Clear session
            document.getElementById('login-overlay').classList.remove('hidden');
            document.getElementById('login-form').reset();
            location.reload(); // Simple reload to clear state
        }

        // --- DATA HANDLING ---
        async function fetchHawksData() {
            // Show loader while fetching initial data
            document.getElementById('content-area').innerHTML = '<div class="flex justify-center items-center h-full"><div class="loader"></div></div>';
            try {
                const { data, error } = await supabase
                    .from('hawks_data')
                    .select('*')
                    .order('name', { ascending: true });
                
                if (error) throw error;
                hawksData = data;
                return data;
            } catch (err) {
                showToast('Failed to fetch data', 'error');
                return [];
            }
        }

        async function toggleParticipation(memberId, eventName, isAdding) {
            const member = hawksData.find(m => m.id == memberId); // Use == for type coercion
            if (!member) return;

            // Confirm Action
            const action = isAdding ? 'add' : 'remove';
            const preposition = isAdding ? 'to' : 'from';
            if (!confirm(`Are you sure you want to ${action} ${member.name} ${preposition} ${eventName}?`)) {
                return;
            }

            let events = member.participated_events || [];
            if (!Array.isArray(events)) events = []; // Handle null/undefined legacy data

            if (isAdding) {
                if (!events.includes(eventName)) events.push(eventName);
            } else {
                events = events.filter(e => e !== eventName);
            }

            // Optimistic UI Update
            member.participated_events = events; 
            renderEventManagement(document.getElementById('event-selector').value, currentView);

            try {
                const { error } = await supabase
                    .from('hawks_data')
                    .update({ participated_events: events })
                    .eq('id', memberId);

                if (error) throw error;
                
                logAction('UPDATE_PARTICIPATION', `${isAdding ? 'Added' : 'Removed'} ${member.name} in ${eventName}`);
                showToast('Updated successfully');
            } catch (err) {
                console.error(err);
                showToast('Update failed, reverting...', 'error');
                // Revert would be complex here, so we just reload data
                await fetchHawksData();
                renderEventManagement(eventName, currentView);
            }
        }

        // --- ROUTING & RENDERING ---
        async function initApp() {
            // Data fetching is now part of the init process
            await fetchHawksData();
            router('on-stage');
        }

        function router(view) {
            currentView = view;
            
            // Update Sidebar Active State
            document.querySelectorAll('.nav-item').forEach(el => {
                if(el.dataset.target === view) el.classList.add('bg-green-700');
                else el.classList.remove('bg-green-700');
            });
            document.querySelectorAll('.mobile-nav-item').forEach(el => {
                if(el.dataset.target === view) el.classList.add('bg-green-700');
                else el.classList.remove('bg-green-700');
            });

            const content = document.getElementById('content-area');
            content.innerHTML = '<div class="flex justify-center h-full items-center"><div class="loader"></div></div>';

            // The timeout is removed for a faster, more responsive feel.
            switch(view) {
                case 'on-stage':
                case 'off-stage':
                case 'sports':
                    renderCategoryView(view);
                    break;
                case 'statistics':
                    renderStatistics();
                    break;
                case 'export':
                    renderExport();
                    break;
                case 'logs':
                    renderLogs();
                    break;
                default:
                    content.innerHTML = '<h2 class="text-2xl text-red-500">404 Not Found</h2>';
            }
        }

        function renderCategoryView(category) {
            const eventsList = EVENTS[category];
            const content = document.getElementById('content-area');
            
            content.innerHTML = `
                <div class="max-w-6xl mx-auto">
                    <h2 class="text-3xl font-bold text-gray-800 capitalize mb-6 border-b pb-4">${category.replace('-', ' ')} Events</h2>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Event to Manage</label>
                        <select id="event-selector" class="block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500 text-lg">
                            ${eventsList.map((e, idx) => `<option value="${e}" ${idx===0?'selected':''}>${e}</option>`).join('')}
                        </select>
                    </div>

                    <div id="participants-container" class="bg-white rounded-xl shadow-md p-6 min-h-[400px]">
                        <!-- List injected here -->
                    </div>
                </div>
            `;

            const selector = document.getElementById('event-selector');
            selector.addEventListener('change', (e) => renderEventManagement(e.target.value, category));
            
            // Initial render
            renderEventManagement(eventsList[0], category);
        }

        function switchMobileTab(tabName, eventName) {
            document.querySelectorAll('.mobile-tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`mobile-tab-${tabName}`).classList.remove('hidden');

            document.querySelectorAll('.mobile-tab-btn').forEach(el => {
                if (el.dataset.tab === tabName) {
                    el.classList.add('bg-green-600', 'text-white');
                    el.classList.remove('bg-gray-200', 'text-gray-700');
                } else {
                    el.classList.remove('bg-green-600', 'text-white');
                    el.classList.add('bg-gray-200', 'text-gray-700');
                }
            });
        }

        function renderEventManagement(eventName, category) {
            const container = document.getElementById('participants-container');
            
            // Partition members: Participating vs Not Participating
            const participating = hawksData.filter(m => (m.participated_events || []).includes(eventName));
            const notParticipating = hawksData.filter(m => !(m.participated_events || []).includes(eventName));

            // Generate HTML
            let html = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-green-700">${eventName}</h3>
                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">Count: ${participating.length}</span>
                </div>

                <div class="hidden lg:grid grid-cols-1 lg:grid-cols-2 gap-8">
                    
                    <!-- Participating Column -->
                    <div class="bg-green-50 p-4 rounded-lg border border-green-100">
                        <h4 class="font-bold text-green-800 mb-3 flex items-center"><i class="ph ph-check-circle mr-2"></i> Participating</h4>
                        ${participating.length === 0 ? '<p class="text-gray-400 italic text-sm p-2">No participants yet.</p>' : ''}
                        <ul class="space-y-2 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar">
                            ${participating.map(m => `
                                <li class="flex justify-between items-center bg-white p-3 rounded shadow-sm hover:shadow-md transition">
                                    <div>
                                        <div class="font-medium text-gray-900">${m.name}</div>
                                        <div class="text-xs text-gray-500">${m.department}</div>
                                    </div>
                                    <button onclick="toggleParticipation('${m.id}', '${eventName}', false)" class="text-red-500 hover:bg-red-50 p-2 rounded-full transition" title="Remove">
                                        <i class="ph ph-minus-circle text-xl"></i>
                                    </button>
                                </li>
                            `).join('')}
                        </ul>
                    </div>

                    <!-- Available Column -->
                    <div class="bg-gray-100 p-4 rounded-lg border border-gray-200">
                        <h4 class="font-bold text-gray-700 mb-3 flex items-center"><i class="ph ph-users mr-2"></i> Available Members</h4>
                        <input type="text" placeholder="Search members..." class="w-full mb-3 p-2 text-sm border rounded focus:outline-none focus:border-green-500" onkeyup="filterAvailable(this)">
                        <ul id="available-list" class="space-y-2 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar">
                            ${notParticipating.map(m => `
                                <li class="member-item flex justify-between items-center bg-white p-3 rounded shadow-sm hover:shadow-md transition opacity-80 hover:opacity-100">
                                    <div>
                                        <div class="font-medium text-gray-800 search-name">${m.name}</div>
                                        <div class="text-xs text-gray-500">${m.department}</div>
                                    </div>
                                    <button onclick="toggleParticipation('${m.id}', '${eventName}', true)" class="text-green-600 hover:bg-green-50 p-2 rounded-full transition" title="Add">
                                        <i class="ph ph-plus-circle text-xl"></i>
                                    </button>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>

                <!-- Mobile Tabbed View -->
                <div class="block lg:hidden">
                    <div class="mb-4 flex rounded-md shadow-sm">
                        <button data-tab="participating" onclick="switchMobileTab('participating', '${eventName}')" class="mobile-tab-btn w-1/2 p-3 font-semibold text-sm rounded-l-md bg-green-600 text-white">
                            Participating (${participating.length})
                        </button>
                        <button data-tab="available" onclick="switchMobileTab('available', '${eventName}')" class="mobile-tab-btn w-1/2 p-3 font-semibold text-sm rounded-r-md bg-gray-200 text-gray-700">
                            Available (${notParticipating.length})
                        </button>
                    </div>

                    <!-- Participating Tab Content -->
                    <div id="mobile-tab-participating" class="mobile-tab-content">
                        ${participating.length === 0 ? '<p class="text-gray-400 italic text-sm p-4">No participants yet.</p>' : ''}
                        <ul class="space-y-2">
                            ${participating.map(m => `
                                <li class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
                                    <div>
                                        <div class="font-medium text-gray-900">${m.name}</div>
                                        <div class="text-xs text-gray-500">${m.department}</div>
                                    </div>
                                    <button onclick="toggleParticipation('${m.id}', '${eventName}', false)" class="text-red-500 hover:bg-red-50 p-2 rounded-full transition" title="Remove">
                                        <i class="ph ph-minus-circle text-xl"></i>
                                    </button>
                                </li>
                            `).join('')}
                        </ul>
                    </div>

                    <!-- Available Tab Content -->
                    <div id="mobile-tab-available" class="mobile-tab-content hidden">
                        <input type="text" placeholder="Search members..." class="w-full mb-3 p-2 text-sm border rounded focus:outline-none focus:border-green-500" onkeyup="filterAvailable(this)">
                        <ul id="available-list" class="space-y-2">
                             ${notParticipating.map(m => `
                                <li class="member-item flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
                                    <div>
                                        <div class="font-medium text-gray-800 search-name">${m.name}</div>
                                        <div class="text-xs text-gray-500">${m.department}</div>
                                    </div>
                                    <button onclick="toggleParticipation('${m.id}', '${eventName}', true)" class="text-green-600 hover:bg-green-50 p-2 rounded-full transition" title="Add">
                                        <i class="ph ph-plus-circle text-xl"></i>
                                    </button>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        function filterAvailable(input) {
            const filter = input.value.toLowerCase();
            document.querySelectorAll('.member-item').forEach(item => {
                const nameEl = item.querySelector('.search-name');
                const originalName = nameEl.dataset.originalName || nameEl.innerText;
                nameEl.dataset.originalName = originalName; // Store it if not already stored
                const name = originalName.toLowerCase();

                if (name.includes(filter) && filter) {
                    item.style.display = '';
                    const regex = new RegExp(filter.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'ig');
                    nameEl.innerHTML = originalName.replace(regex, `<span class="highlight">$&</span>`);
                } else {
                    nameEl.innerHTML = originalName; // Reset
                    item.style.display = name.includes(filter) ? '' : 'none';
                }
            });
        }

        function renderStatistics() {
            const content = document.getElementById('content-area');
            
            // Data Prep
            const memberCounts = hawksData.map(m => ({
                id: m.id,
                name: m.name,
                count: (m.participated_events || []).length,
                dept: m.department
            })).sort((a,b) => b.count - a.count);

            content.innerHTML = `
                <div class="max-w-6xl mx-auto space-y-8">
                    <h2 class="text-3xl font-bold text-gray-800 border-b pb-4">Member Leaderboard</h2>

                    <!-- Individual Stats Table -->
                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <div class="p-4 bg-gray-50 border-b flex flex-col md:flex-row md:justify-between md:items-center gap-3">
                            <div class="font-semibold text-gray-700 self-start">All Members (${memberCounts.length})</div>
                            <input type="text" placeholder="Search by name or department..." class="w-full md:max-w-xs p-2 text-sm border rounded focus:outline-none focus:border-green-500" onkeyup="filterStatsTable(this)">
                        </div>
                        <div class="overflow-x-auto hidden md:block">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Event Count</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="stats-table-body" class="bg-white divide-y divide-gray-200">
                                    ${memberCounts.map((m, i) => `
                                        <tr class="stats-row" data-name="${m.name.toLowerCase()}" data-dept="${m.dept.toLowerCase()}">
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">#${i+1}</td>
                                            <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${m.name}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${m.dept}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                                <span class="px-3 py-1 text-sm font-bold rounded-full ${m.count > 0 ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-700'}">${m.count}</span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                <button onclick="showMemberDetailModal('${m.id}')" class="text-green-600 hover:text-green-800">View Details</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <!-- Mobile Card View -->
                        <div id="stats-card-list" class="block md:hidden p-4 space-y-3 bg-gray-50">
                            ${memberCounts.map((m, i) => `
                                <div class="stats-row bg-white p-4 rounded-lg shadow-sm border" data-name="${m.name.toLowerCase()}" data-dept="${m.dept.toLowerCase()}">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <div class="font-bold text-gray-800">${m.name}</div>
                                            <div class="text-sm text-gray-500">${m.dept}</div>
                                        </div>
                                        <div class="text-sm text-gray-400 font-mono">#${i+1}</div>
                                    </div>
                                    <div class="flex justify-between items-center mt-3 pt-3 border-t">
                                        <span class="px-3 py-1 text-sm font-bold rounded-full ${m.count > 0 ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-700'}">Events: ${m.count}</span>
                                        <button onclick="showMemberDetailModal('${m.id}')" class="text-green-600 hover:text-green-800 font-semibold text-sm">View Details</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function filterStatsTable(input) {
            const filter = input.value.toLowerCase();
            document.querySelectorAll('#stats-table-body .stats-row, #stats-card-list .stats-row').forEach(row => {
                const name = row.dataset.name;
                const dept = row.dataset.dept;
                if (name.includes(filter) || dept.includes(filter)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function showMemberDetailModal(memberId) {
            const member = hawksData.find(m => m.id === memberId);
            if (!member) return;

            const participatingEvents = member.participated_events || [];
            const allEvents = [].concat(...Object.values(EVENTS));
            const availableEvents = allEvents.filter(e => !participatingEvents.includes(e));

            const title = `
                <div>
                    <div class="font-bold text-gray-800">${member.name}</div>
                    <div class="text-sm text-gray-500 font-normal">${member.department}</div>
                </div>
            `;

            const content = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Participating Column -->
                    <div class="space-y-3">
                        <h4 class="font-semibold text-green-700 flex items-center"><i class="ph ph-check-circle mr-2"></i> Participating In (${participatingEvents.length})</h4>
                        ${participatingEvents.length === 0 ? '<p class="text-sm text-gray-400 italic">Not participating in any events.</p>' : ''}
                        <ul class="text-sm space-y-1 text-gray-700 list-disc list-inside">
                            ${participatingEvents.map(e => `<li>${e}</li>`).join('')}
                        </ul>
                    </div>
                    <!-- Available Column -->
                    <div class="space-y-3">
                        <h4 class="font-semibold text-gray-600 flex items-center"><i class="ph ph-user-plus mr-2"></i> Available For (${availableEvents.length})</h4>
                        ${availableEvents.length === 0 ? '<p class="text-sm text-green-600 italic font-medium">Participating in all available events!</p>' : ''}
                        <ul class="text-sm space-y-1 text-gray-500 list-disc list-inside">
                            ${availableEvents.map(e => `<li>${e}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;

            openModal(title, content);
        }

        function renderLogs() {
            const content = document.getElementById('content-area');
            content.innerHTML = '<div class="flex justify-center"><div class="loader"></div></div>';

            supabase.from('hawks_logs').select('*').order('timestamp', { ascending: false }).limit(50)
                .then(({ data, error }) => {
                    if (error) {
                        content.innerHTML = '<p class="text-red-500">Error loading logs</p>';
                        return;
                    }
                    
                    content.innerHTML = `
                        <div class="max-w-6xl mx-auto">
                            <h2 class="text-3xl font-bold text-gray-800 border-b pb-4 mb-6">Activity Logs (Last 50)</h2>
                            <!-- Desktop Table View -->
                            <div class="bg-white rounded-xl shadow overflow-hidden hidden md:block">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Time</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Admin</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Details</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200 text-sm">
                                            ${data.map(log => `
                                                <tr>
                                                    <td class="px-6 py-4 whitespace-nowrap text-gray-500">${new Date(log.timestamp).toLocaleString()}</td>
                                                    <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${log.admin_username}</td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                                            ${log.action}
                                                        </span>
                                                    </td>
                                                    <td class="px-6 py-4 text-gray-500">${log.details}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <!-- Mobile Card View -->
                            <div class="block md:hidden space-y-3">
                                ${data.map(log => `
                                    <div class="bg-white p-4 rounded-lg shadow-sm border">
                                        <div class="flex justify-between items-center text-xs text-gray-500 mb-2">
                                            <span>${new Date(log.timestamp).toLocaleString()}</span>
                                            <span class="px-2 py-1 inline-flex font-semibold rounded-full bg-blue-100 text-blue-800">
                                                ${log.action}
                                            </span>
                                        </div>
                                        <div class="text-sm text-gray-600">
                                            <span class="font-semibold text-gray-800">Admin:</span> ${log.admin_username}
                                        </div>
                                        <div class="text-sm text-gray-600 mt-1">
                                            <span class="font-semibold text-gray-800">Details:</span> ${log.details}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
        }

        function renderExport() {
            const content = document.getElementById('content-area');
            content.innerHTML = `
                <div class="max-w-3xl mx-auto bg-white p-8 rounded-xl shadow-md mt-10">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Export Data</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select Export Scope</label>
                            <div class="flex flex-col md:flex-row md:space-x-4 space-y-2 md:space-y-0">
                                <label class="flex items-center space-x-2 p-3 border rounded cursor-pointer hover:bg-gray-50 w-full">
                                    <input type="radio" name="exportScope" value="all" checked class="text-green-600 focus:ring-green-500">
                                    <span>All Data (Master List)</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 border rounded cursor-pointer hover:bg-gray-50 w-full">
                                    <input type="radio" name="exportScope" value="event-wise" class="text-green-600 focus:ring-green-500">
                                    <span>Event-wise Breakdown</span>
                                </label>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="handleExport('excel')" class="flex items-center justify-center space-x-2 py-4 border border-green-600 text-green-700 rounded-lg hover:bg-green-50 transition">
                                <i class="ph ph-file-xls text-2xl"></i>
                                <span class="font-bold">Download Excel</span>
                            </button>
                            <button onclick="handleExport('pdf')" class="flex items-center justify-center space-x-2 py-4 border border-red-600 text-red-700 rounded-lg hover:bg-red-50 transition">
                                <i class="ph ph-file-pdf text-2xl"></i>
                                <span class="font-bold">Download PDF</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function handleExport(format) {
            const scope = document.querySelector('input[name="exportScope"]:checked').value;
            let exportData = [];

            if (scope === 'all') {
                // Flatten data: Name, Dept, Year, Events (Comma separated)
                exportData = hawksData.map(m => ({
                    Name: m.name,
                    Department: m.department,
                    'Event Count': (m.participated_events || []).length,
                    Events: (m.participated_events || []).join(', ')
                }));
            } else {
                // Event-wise: Event Name, Participant Name, Dept
                Object.keys(EVENTS).forEach(cat => {
                    EVENTS[cat].forEach(evt => {
                        const participants = hawksData.filter(m => (m.participated_events||[]).includes(evt));
                        participants.forEach(p => {
                            exportData.push({
                                Category: cat,
                                Event: evt,
                                Participant: p.name,
                                Department: p.department
                            });
                        });
                    });
                });
            }

            if (format === 'excel') {
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "HawksData");
                XLSX.writeFile(wb, `Hawks_Export_${new Date().toISOString().split('T')[0]}.xlsx`);
                showToast('Excel downloaded');
            } else {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.text("Hawks House Data Export", 14, 15);
                doc.setFontSize(10);
                doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 22);

                const headers = Object.keys(exportData[0]);
                const body = exportData.map(Object.values);

                doc.autoTable({
                    head: [headers],
                    body: body,
                    startY: 30,
                    theme: 'grid',
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [22, 163, 74] } // Green header
                });

                doc.save(`Hawks_Export_${new Date().toISOString().split('T')[0]}.pdf`);
                showToast('PDF downloaded');
            }
            
            logAction('EXPORT', `Exported data as ${format} (${scope})`);
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const contentArea = document.getElementById('content-area');
            const isHidden = menu.classList.contains('hidden');

            if (isHidden) {
                menu.classList.remove('hidden');
                contentArea.addEventListener('click', toggleMobileMenu, { once: true });
            } else {
                menu.classList.add('hidden');
                contentArea.removeEventListener('click', toggleMobileMenu);
            }
        }

        // Check for an existing session on page load
        checkSession();
    </script>
</body>
</html>
